# Changelog

История изменений проекта Telegram Ads Platform (@proday_main_bot)

---

## 2026-01-17

### Добавлено
- **Система биллинга и платных услуг** (масштабное обновление)

  **Балансы пользователя:**
  - Раздельные балансы: рубли (₽) и Telegram Stars (⭐)
  - Новые поля в User: `balance_rub`, `balance_stars`, `total_spent_rub`, `total_spent_stars`
  - Тип аккаунта: `account_type` (free/pro/business)

  **Новые модели БД** (`bot/database/models.py`):
  - `Transaction` — история всех операций с балансом
  - `ExchangeRate` — курсы валют для Stars
  - `Promocode` — промокоды
  - `PromocodeUsage` — использование промокодов
  - `UserServicePurchase` — купленные услуги

  **Конфигурация** (`bot/config/pricing.py`):
  - Типы подписок: Free, PRO, Business
  - Каталог платных услуг: продление, продвижение, закрепление
  - Лимиты по типу аккаунта (объявления, регионы, ссылки, видео)
  - Легко редактируемые цены без изменения кода

  **Сервисы** (`bot/services/`):
  - `billing.py` — пополнение, списание, возвраты, история
  - `exchange_rate.py` — курс Stars (API ЦБ РФ, обновление в 4:00 МСК)
  - `promocodes.py` — валидация и применение промокодов

  **Обработчики** (`bot/handlers/`):
  - `payment.py` — Telegram Stars оплата, покупка услуг
  - `billing.py` — UI баланса, история, промокоды
  - Команды: `/balance`, `/history`

  **Проверка лимитов** (`bot/utils/limits.py`):
  - Проверка лимита объявлений при создании
  - Проверка доступности ссылок, видео, регионов
  - Интеграция в `ad_creation.py`

  **Клавиатуры** (`bot/keyboards/billing.py`):
  - Меню биллинга, пополнения, выбора валюты

  **Миграция БД:**
  - `8d5d1ecf1222_add_billing_tables_and_user_balance_fields`

---

## 2026-01-16

### Добавлено
- **Множественные ссылки в объявлениях** (`bot/handlers/ad_creation.py`, `bot/database/models.py`)
  - Шаг 14: выбор количества ссылок (1-4) или пропуск
  - Последовательный ввод названия и URL для каждой ссылки
  - Миграция БД: `link_title`/`link_url` → `links` (JSONB массив)
  - Отображение всех ссылок в превью и публикации

- **Circuit breaker для LLM-модерации** (`bot/utils/llm_moderation.py`)
  - После 3 ошибок API подряд — автоматическое отключение на 5 минут
  - Умное логирование: первая ошибка как ERROR, остальные не чаще раза в минуту
  - Автоматическое восстановление после таймаута
  - Fallback на rule-based фильтр при недоступности API

---

## 2026-01-15

### Исправлено
- **Фильтр контента** (`bot/utils/content_filter.py`)
  - Исправлены ложные срабатывания на слово "канал" (содержит "анал")
  - Улучшена логика проверки названий ссылок

### Изменено
- **Создание объявлений** (`bot/handlers/ad_creation.py`)
  - Доработана валидация контента при создании объявлений

---

## 2026-01-14

### Добавлено
- **LLM-модерация объявлений** (`bot/utils/llm_moderation.py`)
  - Интеграция с Claude API для умной модерации
  - Учёт категории объявления при проверке (контекстная модерация)
  - Настраиваемый порог уверенности

- **Поля для ссылок в объявлениях** (`bot/database/models.py`, миграция)
  - Возможность прикреплять ссылку к объявлению
  - Название ссылки (link_title) и URL (link_url)

- **Antiflood middleware** (`bot/middlewares/antiflood.py`)
  - Защита от спама сообщениями

### Изменено
- **Управление объявлениями** (`bot/handlers/ad_management.py`)
  - Улучшен интерфейс управления объявлениями

- **Стартовый хендлер** (`bot/handlers/start.py`)
  - Обновлено приветственное сообщение

---

## 2026-01-13

### Добавлено
- **Избранное** (`bot/handlers/favorites.py`)
  - Возможность добавлять объявления в избранное

- **Комментарии** (`bot/handlers/comments.py`)
  - Система комментариев к объявлениям

---

<!--
Формат записи:

## ГГГГ-ММ-ДД

### Добавлено (новые функции)
### Изменено (изменения в существующих функциях)
### Исправлено (баг-фиксы)
### Удалено (удалённые функции)

- **Краткое описание** (`путь/к/файлу.py`)
  - Детали изменения
-->
